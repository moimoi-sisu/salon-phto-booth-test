<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>サロン撮影ブース（フレーム合成）</title>
<style>
  :root { --brand:#00b3a4; }
  * { box-sizing:border-box; }
  body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif; background:#0e0e0f; color:#fff; }
  header, footer { position:fixed; left:0; right:0; z-index:10; background:#0008; backdrop-filter:saturate(120%) blur(6px); }
  header { top:0; padding:10px 12px; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  footer { bottom:0; padding:10px 12px; display:flex; gap:10px; justify-content:center; }
  main { min-height:100svh; display:grid; place-items:center; padding:64px 12px; }
  #stage { position:relative; width:min(100vw, calc(100svh - 160px)); aspect-ratio:3/4; background:#1a1a1c; border:1px solid #2b2b2e; border-radius:12px; overflow:hidden; }
  #video, #frame, #canvas { position:absolute; inset:0; width:100%; height:100%; object-fit:cover; }
  #frame { pointer-events:none; }
  #canvas { display:none; }
  .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .pill { background:#ffffff1a; padding:6px 10px; border-radius:999px; }
  label { font-size:14px; opacity:.92; }
  select, input[type="file"] { font-size:14px; }
  .btn { background:var(--brand); border:none; padding:12px 16px; border-radius:10px; color:#fff; font-weight:700; cursor:pointer; }
  .btn.secondary { background:#3a3a3f; }
  .hint { font-size:12px; opacity:.8; }
  a.link { color:#7fd; text-decoration:none; }
</style>
</head>
<body>
  <header class="row">
    <span class="pill">サロン撮影ブース</span>

    <label class="row">フレーム画像を選択
      <input id="file" type="file" accept="image/png,image/webp" />
    </label>

    <label class="row">アスペクト比
      <select id="ratio">
        <option value="3/4" selected>3:4（縦・おすすめ）</option>
        <option value="4/5">4:5（Instagram）</option>
        <option value="1/1">1:1（正方形）</option>
        <option value="9/16">9:16（リール）</option>
      </select>
    </label>

    <label class="row"><input id="flip" type="checkbox"> ミラー表示（インカメラ風）</label>

    <label class="row">カメラ
      <select id="devices"></select>
    </label>

    <span class="hint">フレームは**透過PNG**推奨／中央は広めに空ける</span>
  </header>

  <main>
    <div id="stage">
      <video id="video" autoplay playsinline muted></video>
      <img id="frame" alt="">
      <canvas id="canvas"></canvas>
    </div>
  </main>

  <footer>
    <button id="shot" class="btn">撮影して保存</button>
    <button id="clear" class="btn secondary">フレーム消去</button>
  </footer>

<script>
const els = (id)=>document.getElementById(id);
const video = els('video');
const frame = els('frame');
const file  = els('file');
const shot  = els('shot');
const clearBtn = els('clear');
const ratioSel = els('ratio');
const flipChk  = els('flip');
const devicesSel = els('devices');
const stage = els('stage');
const canvas = els('canvas');

let stream, currentDeviceId;

async function listCameras() {
  const devices = await navigator.mediaDevices.enumerateDevices();
  const cams = devices.filter(d => d.kind === 'videoinput');
  devicesSel.innerHTML = '';
  cams.forEach((c,i) => {
    const opt = document.createElement('option');
    opt.value = c.deviceId;
    opt.textContent = c.label || `カメラ ${i+1}`;
    devicesSel.appendChild(opt);
  });
  if (!currentDeviceId && cams[0]) currentDeviceId = cams[0].deviceId;
  devicesSel.value = currentDeviceId || '';
}

async function startCamera(deviceId) {
  if (stream) stream.getTracks().forEach(t => t.stop());
  stream = await navigator.mediaDevices.getUserMedia({
    video: deviceId ? {deviceId: {exact: deviceId}} : {facingMode:'environment'},
    audio: false
  });
  video.srcObject = stream;
  currentDeviceId = deviceId || null;
  await listCameras();
}

ratioSel.addEventListener('change', ()=> {
  stage.style.aspectRatio = ratioSel.value;
});

flipChk.addEventListener('change', ()=> {
  const s = flipChk.checked ? 'scaleX(-1)' : 'none';
  video.style.transform = s;
  frame.style.transform = s;
});

devicesSel.addEventListener('change', ()=> startCamera(devicesSel.value));

file.addEventListener('change', e => {
  const f = e.target.files[0];
  if (!f) return;
  const url = URL.createObjectURL(f);
  frame.src = url;
});

clearBtn.addEventListener('click', ()=> {
  frame.removeAttribute('src');
  file.value = '';
});

shot.addEventListener('click', ()=> {
  const rect = stage.getBoundingClientRect();
  const dpr = window.devicePixelRatio || 1;
  canvas.width = Math.round(rect.width * dpr);
  canvas.height = Math.round(rect.height * dpr);
  const ctx = canvas.getContext('2d');
  ctx.setTransform(dpr,0,0,dpr,0,0);

  // 1) 背景（動画）
  if (flipChk.checked) { // 見た目と同じ向きで出力
    ctx.translate(rect.width, 0);
    ctx.scale(-1, 1);
  }
  ctx.drawImage(video, 0, 0, rect.width, rect.height);

  // 2) フレーム
  if (frame.src) {
    if (flipChk.checked) { // フレームは反転を戻す（見た目通り）
      ctx.scale(-1,1);
      ctx.translate(-rect.width,0);
    }
    ctx.drawImage(frame, 0, 0, rect.width, rect.height);
  }

  canvas.toBlob(blob => {
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    const ts = new Date().toISOString().replace(/[:.]/g,'');
    a.download = `salon_${ts}.png`;
    a.click();
    URL.revokeObjectURL(a.href);
  }, 'image/png');
});

(async () => {
  try {
    await startCamera();          // localhostはHTTPS扱いでOK
    ratioSel.dispatchEvent(new Event('change'));
  } catch (e) {
    alert('カメラにアクセスできません。\nブラウザの許可設定を確認してください。\n\n' + e);
    console.error(e);
  }
})();
</script>
</body>
</html>
